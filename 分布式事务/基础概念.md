# 基础概念

[TOC]

## 定义

事务提供一种机制将一个活动涉及的所有操作都纳入到一个不可分割的执行单元，组成事务的祝所有操作只有在操作均正常执行的情况下才能提交，只要其中任一操作执行失败，都会导致整个事务的回滚。



四大特性：

- **A（Atomic）**：原子性，构成事务的所有操作，要么都执行完成，要么全部不执行，不可能出现部分成功部分失败的情况。

- **C（Consistency）**：一致性，在事务执行前后，数据库的一致性约束没有被破坏。一旦所有事务动作完成，事务就被提交，数据和资源处于一种满足业务规则的一致性状态中。

- **I（Isolation）**：隔离性，数据库中的事务一般都是并发的，隔离性是指并发的两个事务互不干扰，一个事务不能看到其他事务运行过程的中间状态，通过配置事务隔离级别可以避免在脏读、幻读、不可重复读等问题。

- **D（Durability）**：持久性，事务完成之后，该事务对数据的更改会持久到数据库，且不会被回滚。



### 单体事务

在计算机系统中，更多的是通过关系型数据库来控制事务，这是利用数据库本身的事务特性来实现的，因此叫数据库事务，由于应用主要靠关系数据库来控制事务，而数据库通常和应用在同一个服务器，所以基于关系型数据库的事务又被称为单体事务。

![image-20210621111243828](https://gitee.com/tizo_kingbb/picImg/raw/master/img/20210621111243.png)

### 分布式事务

分布式事务就是指事务的参与者，支持事务的服务器，资源服务器以及事务管理器分别位于不同的分布式系统的不同服务节点之上。

![image-20210621113927064](https://gitee.com/tizo_kingbb/picImg/raw/master/img/20210621113927.png)



要了解分布式事务，则必须先清楚分布式系统的CAP理论：

- **C（Consistency）**：一致性。在分布式系统完成某写操作后任何读操作，都应该获取到该写操作写入的那个最新的值。相当于要求分布式系统中的各节点时时刻刻保持数据的一致性。如服务A、B、C三个节点都存储了用户数据，三个节点的数据都需要保持同一时刻数据一致性。

- **A（Availability）**：可用性。 一直可以正常的做读写操作。简单而言就是客户端一直可以正常访问并得到系统的正常响应。用户角度来看就是不会出现系统操作失败或者访问超时等问题。如服务A、B、C三个节点，其中一个节点如果宕机了，不能影响整个集群对外提供服务。

- **P（Partition Tolerance）**：分区容错性。指允许系统通过网络协同工作，分区容错性要解决由于网络分区导致数据的不完整及无法访问等问题。



目前来说**CAP** 无法都兼备，因此引入了 **BASE理论** 。它是用来对 **CAP理论** 进行一些补充：

- **BA（Basically Available）**：基本可用。指分布式系统在出现不可预知故障的时候，允许损失部分可用性
- **S（Soft State）**：软状态。指允许系统中的数据存在中间状态，并认为该中间状态的存在不会影响系统的整体可用性，即允许系统在不同节点的数据副本之间进行数据同步的过程存在延时
- **E（Eventually Consistent）**：最终一致性。最终一致性强调的是系统中所有的数据副本，在经过一段时间的同步后，最终能够达到一个一致的状态。因此，最终一致性的本质是需要系统保证最终数据能够达到一致，而不需要实时保证系统数据的强一致性

这个理论的核心思想便是：如果我们无法做到强一致性，那么每个应用都应该根据自身的业务特点，采用适当的方式来使系统达到最终一致性。



### 应用场景

#### 场景1： 分库分表

如下图所示，分库分表后原来在一个数据库上就能完成的写操作，可能就会跨多个数据库，这就产生了跨数据库事务问题。

![image-20210621142141558](https://gitee.com/tizo_kingbb/picImg/raw/master/img/20210621142141.png)

#### 场景2：分布式架构

业务系统按照服务拆分之后，一个完整的业务往往需要调用多个服务，如何保证多个服务间的数据一致性成为一个难题。

![image-20210621170501595](https://gitee.com/tizo_kingbb/picImg/raw/master/img/20210621170501.png)



### 解决方法

目前主流的解决方法有：TCC、两段式提交、三段式提交、最大努力通知、可靠消息事务等。





参考文档：

- https://www.cnblogs.com/dyzcs/p/13780668.html
- https://www.cnblogs.com/mingorun/p/11025538.html
- https://zhuanlan.zhihu.com/p/141376066

